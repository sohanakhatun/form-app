{% comment %}
  Contact Form Block
  This block can be added to any section in the theme customizer
  No code or configuration required - just drag and drop!
{% endcomment %}

<div class="form-builder-contact-form" id="form-builder-{{ block.id }}">
  <style>
    .form-builder-contact-form {
      max-width: {{ block.settings.max_width }}px;
      margin: 0 auto;
      padding: {{ block.settings.padding_top }}px {{ block.settings.padding_sides }}px {{ block.settings.padding_bottom }}px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    }
    
    .form-builder-contact-form h2 {
      margin-top: 0;
      margin-bottom: 10px;
      font-size: {{ block.settings.heading_size }}px;
      color: {{ block.settings.heading_color }};
    }
    
    .form-builder-contact-form .form-description {
      margin-bottom: 20px;
      color: #666;
      font-size: 14px;
    }
    
    .form-builder-contact-form .form-group {
      margin-bottom: 20px;
    }
    
    .form-builder-contact-form label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #333;
    }
    
    .form-builder-contact-form .required {
      color: #d32f2f;
    }
    
    .form-builder-contact-form input[type="text"],
    .form-builder-contact-form input[type="email"],
    .form-builder-contact-form input[type="tel"] {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
      box-sizing: border-box;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-builder-contact-form input:focus {
      outline: none;
      border-color: {{ block.settings.button_color }};
      box-shadow: 0 0 0 2px rgba(0, 128, 96, 0.1);
    }
    
    .form-builder-contact-form button[type="submit"] {
      width: 100%;
      padding: 12px 24px;
      background-color: {{ block.settings.button_color }};
      color: {{ block.settings.button_text_color }};
      border: none;
      border-radius: 4px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s, opacity 0.2s;
    }
    
    .form-builder-contact-form button[type="submit"]:hover:not(:disabled) {
      opacity: 0.9;
    }
    
    .form-builder-contact-form button[type="submit"]:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    .form-builder-contact-form .form-message {
      padding: 12px;
      border-radius: 4px;
      margin-bottom: 20px;
      display: none;
    }
    
    .form-builder-contact-form .form-message.show {
      display: block;
    }
    
    .form-builder-contact-form .form-message.success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    
    .form-builder-contact-form .form-message.error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
  </style>

  {% if block.settings.heading != blank %}
    <h2>{{ block.settings.heading }}</h2>
  {% endif %}
  
  {% if block.settings.description != blank %}
    <p class="form-description">{{ block.settings.description }}</p>
  {% endif %}
  
  <div class="form-message" id="form-message-{{ block.id }}"></div>
  
  <form id="contact-form-{{ block.id }}">
    <div class="form-group">
      <label for="name-{{ block.id }}">
        {{ block.settings.name_label }} <span class="required">*</span>
      </label>
      <input
        type="text"
        id="name-{{ block.id }}"
        name="name"
        required
        placeholder="{{ block.settings.name_placeholder }}"
      />
    </div>
    
    <div class="form-group">
      <label for="email-{{ block.id }}">
        {{ block.settings.email_label }} <span class="required">*</span>
      </label>
      <input
        type="email"
        id="email-{{ block.id }}"
        name="email"
        required
        placeholder="{{ block.settings.email_placeholder }}"
      />
    </div>
    
    <div class="form-group">
      <label for="phone-{{ block.id }}">
        {{ block.settings.phone_label }} <span class="required">*</span>
      </label>
      <input
        type="tel"
        id="phone-{{ block.id }}"
        name="phone"
        required
        placeholder="{{ block.settings.phone_placeholder }}"
      />
    </div>
    
    <button type="submit" id="submit-button-{{ block.id }}">
      {{ block.settings.button_text }}
    </button>
  </form>
</div>

<script>
(function() {
  'use strict';
  
  const blockId = '{{ block.id }}';
  const formId = 'contact-form-' + blockId;
  const messageId = 'form-message-' + blockId;
  const submitButtonId = 'submit-button-' + blockId;
  let appUrl = 'https://form-builder-app-mcyu.onrender.com';
  
  if (!appUrl || appUrl === '') {
    if (typeof window !== 'undefined' && window.Shopify && window.Shopify.appUrl) {
      appUrl = window.Shopify.appUrl;
    } else {
      const currentHost = window.location.hostname;
      appUrl = window.location.origin;
    }
  }
  
  const apiUrl = appUrl + '/api/public/submit';
  
  // Get shop domain
  const shopDomain = (typeof Shopify !== 'undefined' && Shopify.shop) 
    ? Shopify.shop 
    : window.location.hostname.replace('.myshopify.com', '');
  
  const form = document.getElementById(formId);
  const messageDiv = document.getElementById(messageId);
  const submitButton = document.getElementById(submitButtonId);
  
  if (!form) return;
  
  function showMessage(text, type) {
    messageDiv.textContent = text;
    messageDiv.className = 'form-message show ' + type;
    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    
    if (type === 'success') {
      setTimeout(() => {
        messageDiv.className = 'form-message';
        messageDiv.textContent = '';
      }, 5000);
    }
  }
  
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(form);
    
    // Add shop domain if available
    if (shopDomain) {
      formData.append('shop', shopDomain);
    }
    
    // Disable submit button
    submitButton.disabled = true;
    const originalText = submitButton.textContent;
    submitButton.textContent = '{{ block.settings.submitting_text }}';
    messageDiv.className = 'form-message';
    messageDiv.textContent = '';
    
    try {
      const response = await fetch(apiUrl, {
        method: 'POST',
        body: formData,
      });
      
      const data = await response.json();
      
      if (response.ok) {
        showMessage('{{ block.settings.success_message }}', 'success');
        form.reset();
      } else {
        showMessage('Error: ' + (data.error || '{{ block.settings.error_message }}'), 'error');
      }
    } catch (error) {
      console.error('Form submission error:', error);
      showMessage('{{ block.settings.error_message }}', 'error');
    } finally {
      submitButton.disabled = false;
      submitButton.textContent = originalText;
    }
  });
})();
</script>

{% schema %}
{
  "name": "Contact Form",
  "target": "section",
  "settings": [
    {
      "type": "header",
      "content": "Content"
    },
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Contact Us"
    },
    {
      "type": "textarea",
      "id": "description",
      "label": "Description",
      "default": "Fill out the form below and we'll get back to you soon!"
    },
    {
      "type": "header",
      "content": "Form Fields"
    },
    {
      "type": "text",
      "id": "name_label",
      "label": "Name Label",
      "default": "Name"
    },
    {
      "type": "text",
      "id": "name_placeholder",
      "label": "Name Placeholder",
      "default": "Enter your name"
    },
    {
      "type": "text",
      "id": "email_label",
      "label": "Email Label",
      "default": "Email"
    },
    {
      "type": "text",
      "id": "email_placeholder",
      "label": "Email Placeholder",
      "default": "Enter your email"
    },
    {
      "type": "text",
      "id": "phone_label",
      "label": "Phone Label",
      "default": "Phone Number"
    },
    {
      "type": "text",
      "id": "phone_placeholder",
      "label": "Phone Placeholder",
      "default": "Enter your phone number"
    },
    {
      "type": "header",
      "content": "Button"
    },
    {
      "type": "text",
      "id": "button_text",
      "label": "Button Text",
      "default": "Submit"
    },
    {
      "type": "text",
      "id": "submitting_text",
      "label": "Submitting Text",
      "default": "Submitting..."
    },
    {
      "type": "header",
      "content": "Messages"
    },
    {
      "type": "text",
      "id": "success_message",
      "label": "Success Message",
      "default": "âœ“ Thank you! Your form has been submitted successfully."
    },
    {
      "type": "text",
      "id": "error_message",
      "label": "Error Message",
      "default": "An error occurred. Please try again later."
    },
    {
      "type": "header",
      "content": "Styling"
    },
    {
      "type": "range",
      "id": "max_width",
      "label": "Max Width (px)",
      "min": 300,
      "max": 800,
      "step": 50,
      "default": 500
    },
    {
      "type": "range",
      "id": "padding_top",
      "label": "Padding Top (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "padding_sides",
      "label": "Padding Sides (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "label": "Padding Bottom (px)",
      "min": 0,
      "max": 100,
      "step": 5,
      "default": 20
    },
    {
      "type": "range",
      "id": "heading_size",
      "label": "Heading Size (px)",
      "min": 20,
      "max": 48,
      "step": 2,
      "default": 28
    },
    {
      "type": "color",
      "id": "heading_color",
      "label": "Heading Color",
      "default": "#000000"
    },
    {
      "type": "color",
      "id": "button_color",
      "label": "Button Color",
      "default": "#008060"
    },
    {
      "type": "color",
      "id": "button_text_color",
      "label": "Button Text Color",
      "default": "#ffffff"
    }
  ]
}
{% endschema %}

